---
title: Promiseä¸­çš„allå’Œrace
tags:
  - JavaScript
  - ES6
categories:
  - ES6
---



### 4. Promiseä¸­çš„allå’Œrace

`.all()`çš„ä½œç”¨æ˜¯æŽ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åŽå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®ŒåŽæ‰æ‰§è¡Œå›žè°ƒã€‚

`.race()`çš„ä½œç”¨ä¹Ÿæ˜¯æŽ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åŽå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåªä¿ç•™å–ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„å¼‚æ­¥æ“ä½œçš„ç»“æžœï¼Œå…¶ä»–çš„æ–¹æ³•ä»åœ¨æ‰§è¡Œï¼Œä¸è¿‡æ‰§è¡Œç»“æžœä¼šè¢«æŠ›å¼ƒã€‚

#### 4.1 Promise.allä¸­æ²¡æœ‰å¼‚å¸¸

æˆ‘ä»¬çŸ¥é“å¦‚æžœç›´æŽ¥åœ¨è„šæœ¬æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ª`Promise`ï¼Œå®ƒæž„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼šç«‹å³æ‰§è¡Œçš„ï¼Œå°±åƒè¿™æ ·ï¼š

```
const p1 = new Promise(r => console.log('ç«‹å³æ‰“å°'))
```

æŽ§åˆ¶å°ä¸­ä¼šç«‹å³æ‰“å°å‡º â€œç«‹å³æ‰“å°â€ã€‚

å› æ­¤ä¸ºäº†æŽ§åˆ¶å®ƒä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå‡½æ•°åŒ…è£¹ç€å®ƒï¼Œåœ¨éœ€è¦å®ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°å°±å¯ä»¥äº†ï¼š

```js
function runP1 () {
    const p1 = new Promise(r => console.log('ç«‹å³æ‰“å°'))
    return p1
}
runP1() // è°ƒç”¨æ­¤å‡½æ•°æ—¶æ‰æ‰§è¡Œ
```

çŽ°åœ¨æ¥æž„å»ºè¿™ä¹ˆä¸€ä¸ªå‡½æ•°ï¼š

```js
function runAsync (x) {
    const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
    return p
}
```

è¯¥å‡½æ•°ä¼ å…¥ä¸€ä¸ªå€¼`x`ï¼Œç„¶åŽé—´éš”ä¸€ç§’åŽæ‰“å°å‡ºè¿™ä¸ª`x`ã€‚

å¦‚æžœæˆ‘ç”¨`.all()`æ¥æ‰§è¡Œå®ƒä¼šæ€Žæ ·å‘¢ï¼Ÿ

```js
function runAsync (x) {
    const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
    return p
}
Promise.all([runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log(res))
```

å…ˆæ¥æƒ³æƒ³æ­¤æ®µä»£ç åœ¨æµè§ˆå™¨ä¸­ä¼šå¦‚ä½•æ‰§è¡Œï¼Ÿ

æ²¡é”™ï¼Œå½“ä½ æ‰“å¼€é¡µé¢çš„æ—¶å€™ï¼Œåœ¨é—´éš”ä¸€ç§’åŽï¼ŒæŽ§åˆ¶å°ä¼šåŒæ—¶æ‰“å°å‡º`1, 2, 3`ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•°ç»„`[1, 2, 3]`ã€‚

```
1
2
3
[1, 2, 3]
```

æ‰€ä»¥ä½ çŽ°åœ¨èƒ½ç†è§£è¿™å¥è¯çš„æ„æ€äº†å—ï¼š**æœ‰äº†allï¼Œä½ å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªå›žè°ƒä¸­å¤„ç†æ‰€æœ‰çš„è¿”å›žæ•°æ®ã€‚**

`.all()`åŽé¢çš„`.then()`é‡Œçš„å›žè°ƒå‡½æ•°æŽ¥æ”¶çš„å°±æ˜¯æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„ç»“æžœã€‚

è€Œä¸”è¿™ä¸ªç»“æžœä¸­æ•°ç»„çš„é¡ºåºå’Œ`Promise.all()`æŽ¥æ”¶åˆ°çš„æ•°ç»„é¡ºåºä¸€è‡´ï¼ï¼ï¼

> æœ‰ä¸€ä¸ªåœºæ™¯æ˜¯å¾ˆé€‚åˆç”¨è¿™ä¸ªçš„ï¼Œä¸€äº›æ¸¸æˆç±»çš„ç´ ææ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œæ‰“å¼€ç½‘é¡µæ—¶ï¼Œé¢„å…ˆåŠ è½½éœ€è¦ç”¨åˆ°çš„å„ç§èµ„æºå¦‚å›¾ç‰‡ã€flashä»¥åŠå„ç§é™æ€æ–‡ä»¶ã€‚æ‰€æœ‰çš„éƒ½åŠ è½½å®ŒåŽï¼Œæˆ‘ä»¬å†è¿›è¡Œé¡µé¢çš„åˆå§‹åŒ–ã€‚

#### 4.2  Promise.allä¸­æœ‰å¼‚å¸¸

æˆ‘æ–°å¢žäº†ä¸€ä¸ª`runReject`å‡½æ•°ï¼Œå®ƒç”¨æ¥åœ¨`1000 * x`ç§’åŽ`reject`ä¸€ä¸ªé”™è¯¯ã€‚

åŒæ—¶`.catch()`å‡½æ•°èƒ½å¤Ÿæ•èŽ·åˆ°`.all()`é‡Œæœ€å…ˆçš„é‚£ä¸ªå¼‚å¸¸ï¼Œå¹¶ä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚

ä¼šæ€Žæ ·æ‰§è¡Œå‘¢ ï¼Ÿ

```js
function runAsync (x) {
  const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
  return p
}
function runReject (x) {
  const p = new Promise((res, rej) => setTimeout(() => rej(`Error: ${x}`, console.log(x)), 1000 * x))
  return p
}
Promise.all([runAsync(1), runReject(4), runAsync(3), runReject(2)])
  .then(res => console.log(res))
  .catch(err => console.log(err))
```

æ‰§è¡Œç»“æžœ

```
// 1såŽè¾“å‡º
1
3
// 2såŽè¾“å‡º
2
Error: 2
// 4såŽè¾“å‡º
4
```

`.catch`æ˜¯ä¼šæ•èŽ·æœ€å…ˆçš„é‚£ä¸ªå¼‚å¸¸ï¼Œåœ¨è¿™é“é¢˜ç›®ä¸­æœ€å…ˆçš„å¼‚å¸¸å°±æ˜¯`runReject(2)`çš„ç»“æžœã€‚

å¦å¤–ï¼Œå¦‚æžœä¸€ç»„å¼‚æ­¥æ“ä½œä¸­æœ‰ä¸€ä¸ªå¼‚å¸¸éƒ½ä¸ä¼šè¿›å…¥`.then()`çš„ç¬¬ä¸€ä¸ªå›žè°ƒå‡½æ•°å‚æ•°ä¸­ã€‚

æ³¨æ„ï¼Œä¸ºä»€ä¹ˆä¸è¯´æ˜¯ä¸è¿›å…¥`.then()`ä¸­å‘¢ ðŸ¤”ï¸ï¼Ÿ

å“ˆå“ˆï¼Œå¤§å®¶åˆ«å¿˜äº†`.then()`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ•èŽ·é”™è¯¯çš„ï¼š

```
Promise.all([runAsync(1), runReject(4), runAsync(3), runReject(2)])
  .then(res => console.log(res), 
  err => console.log(err))
```

#### 4.3 Promise.raceä¸­æ²¡æœ‰å¼‚å¸¸

`race`ï¼Œæ¯”èµ›ï¼Œèµ›è·‘çš„æ„æ€ã€‚

æ‰€ä»¥ä½¿ç”¨`.race()`æ–¹æ³•ï¼Œå®ƒåªä¼šèŽ·å–æœ€å…ˆæ‰§è¡Œå®Œæˆçš„é‚£ä¸ªç»“æžœï¼Œå…¶å®ƒçš„å¼‚æ­¥ä»»åŠ¡è™½ç„¶ä¹Ÿä¼šç»§ç»­è¿›è¡Œä¸‹åŽ»ï¼Œä¸è¿‡`race`å·²ç»ä¸ç®¡é‚£äº›ä»»åŠ¡çš„ç»“æžœäº†ã€‚

```js
function runAsync (x) {
  const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
  return p
}
Promise.race([runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log('result: ', res))
  .catch(err => console.log(err))
```

æ‰§è¡Œç»“æžœä¸ºï¼š

```
1
'result: ' 1
2
3
å¤åˆ¶ä»£ç 
```

> è¿™ä¸ªraceæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä½¿ç”¨åœºæ™¯è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨raceç»™æŸä¸ªå¼‚æ­¥è¯·æ±‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¶…æ—¶åŽæ‰§è¡Œç›¸åº”çš„æ“ä½œ

#### 4.4 Promise.raceä¸­æœ‰å¼‚å¸¸

```JS
function runAsync(x) {
  const p = new Promise(r =>
    setTimeout(() => r(x, console.log(x)), 1000)
  );
  return p;
}
function runReject(x) {
  const p = new Promise((res, rej) =>
    setTimeout(() => rej(`Error: ${x}`, console.log(x)), 1000 * x)
  );
  return p;
}
Promise.race([runReject(0), runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log("result: ", res))
  .catch(err => console.log(err));
```

é‡åˆ°é”™è¯¯çš„è¯ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œ`runReject(0)`æœ€å…ˆæ‰§è¡Œå®Œï¼Œæ‰€ä»¥è¿›å…¥äº†`catch()`ä¸­ï¼š

```
0
'Error: 0'
1
2
3
```

#### æ€»ç»“

- `Promise.all()`çš„ä½œç”¨æ˜¯æŽ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åŽå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®ŒåŽæ‰æ‰§è¡Œå›žè°ƒã€‚
- `.race()`çš„ä½œç”¨ä¹Ÿæ˜¯æŽ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åŽå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåªä¿ç•™å–ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„å¼‚æ­¥æ“ä½œçš„ç»“æžœï¼Œå…¶ä»–çš„æ–¹æ³•ä»åœ¨æ‰§è¡Œï¼Œä¸è¿‡æ‰§è¡Œç»“æžœä¼šè¢«æŠ›å¼ƒã€‚
- `Promise.all().then()`ç»“æžœä¸­æ•°ç»„çš„é¡ºåºå’Œ`Promise.all()`æŽ¥æ”¶åˆ°çš„æ•°ç»„é¡ºåºä¸€è‡´ã€‚
- `allå’Œrace`ä¼ å…¥çš„æ•°ç»„ä¸­å¦‚æžœæœ‰ä¼šæŠ›å‡ºå¼‚å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆåªæœ‰æœ€å…ˆæŠ›å‡ºçš„é”™è¯¯ä¼šè¢«æ•èŽ·ï¼Œå¹¶ä¸”æ˜¯è¢«`then`çš„ç¬¬äºŒä¸ªå‚æ•°æˆ–è€…åŽé¢çš„`catch`æ•èŽ·ï¼›ä½†å¹¶ä¸ä¼šå½±å“æ•°ç»„ä¸­å…¶å®ƒçš„å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚





> è½¬è‡ªï¼š
>
> https://juejin.cn/post/6844904077537574919